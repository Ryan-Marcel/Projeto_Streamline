@{
    ViewData["Title"] = "Dashboard";
}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/dashboard.css" />
    <link rel="stylesheet" href="~/css/header.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <partial name="_HeaderADM" />

    <div class="titulo">
        <div class="bg1">
            <h1>Dashboard Geral</h1>
        </div>
        <div class="bg2"></div>
    </div>

    <section class="container dashboard-container">
        
        <!-- Se√ß√£o de Gr√°ficos -->
        <div class="dashboard-graphics">
            <!-- Gr√°fico de Pizza - Status das Notifica√ß√µes -->
            <div class="dashboard-graphic-card">
                <div class="card-header">
                    <h3>Status das Notifica√ß√µes</h3>
                </div>
                <canvas id="statusChart"></canvas>
            </div>

            <!-- Gr√°fico de Linha - Notifica√ß√µes por M√™s -->
            <div class="dashboard-graphic-card">
                <div class="card-header">
                    <h3>Notifica√ß√µes por M√™s</h3>
                </div>
                <canvas id="monthlyChart"></canvas>
            </div>

            <!-- Gr√°fico de Barras - Solicita√ß√µes por Sala -->
            <div class="dashboard-graphic-card">
                <div class="card-header">
                    <h3>Solicita√ß√µes por Sala</h3>
                </div>
                <canvas id="salaChart"></canvas>
            </div>

            <!-- Card de Computadores Mais Defeituosos -->
            <div class="dashboard-graphic-card defective-computers-card">
                <div class="card-header">
                    <h3>Computadores Mais Defeituosos</h3>
                </div>
                <div class="defective-computers-list" id="defectiveComputersList">
                    <div class="loading">Carregando...</div>
                </div>
            </div>
        </div>

        <a asp-controller="Principal" asp-action="IndexADM" id="voltar">Voltar</a>
    </section>


    <script>
// Vari√°vel para controlar o intervalo
let refreshInterval;

Chart.defaults.font.family = 'Stack-Sans, system-ui, sans-serif';
Chart.defaults.font.size = 14;
Chart.defaults.color = '#333';

// Objetos para armazenar as inst√¢ncias dos gr√°ficos
let statusChartInstance = null;
let monthlyChartInstance = null;
let salaChartInstance = null;

async function loadStatusChart() {
    try {
        const response = await fetch('@Url.Action("GetStatusData", "Dashboard")');
        const data = await response.json();

        const ctx = document.getElementById('statusChart').getContext('2d');
        
        if (statusChartInstance) {
            statusChartInstance.destroy();
        }
        
        statusChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#ff6384', 
                        '#4caf50', 
                        '#ffce56' 
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 13
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao carregar gr√°fico de status:', error);
    }
}

async function loadMonthlyChart() {
    try {
        const response = await fetch('@Url.Action("GetMonthlyData", "Dashboard")');
        const data = await response.json();

        const ctx = document.getElementById('monthlyChart').getContext('2d');
        
        if (monthlyChartInstance) {
            monthlyChartInstance.destroy();
        }
        
        monthlyChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Notifica√ß√µes',
                    data: data.data,
                    borderColor: '#2196f3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#2196f3',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao carregar gr√°fico mensal:', error);
    }
}

async function loadSalaChart() {
    try {
        const response = await fetch('@Url.Action("GetSalaData", "Dashboard")');
        const data = await response.json();

        const ctx = document.getElementById('salaChart').getContext('2d');
        
        if (salaChartInstance) {
            salaChartInstance.destroy();
        }
        
        salaChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Solicita√ß√µes',
                    data: data.data,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Solicita√ß√µes: ${context.parsed.y}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao carregar gr√°fico de salas:', error);
    }
}

async function loadDefectiveComputers() {
    try {
        const response = await fetch('@Url.Action("GetTopDefectiveComputers", "Dashboard")');
        const computers = await response.json();

        const listElement = document.getElementById('defectiveComputersList');
        
        if (computers.length === 0) {
            listElement.innerHTML = '<div class="no-data">Nenhum computador com solicita√ß√µes encontrado</div>';
            return;
        }

        listElement.innerHTML = computers.map((comp, index) => `
            <div class="defective-computer-item" onclick="window.location.href='@Url.Action("DetalhesComputador", "Principal")?id=${comp.computadorId}'">
                <div class="computer-rank">#${index + 1}</div>
                <div class="computer-info">
                    <div class="computer-name">
                        <span class="icon">üíª</span>
                        <strong>${comp.computadorNome}</strong>
                    </div>
                    <div class="computer-stats">
                        <span class="stat total">
                            <strong>${comp.totalSolicitacoes}</strong> solicita√ß√µes
                        </span>
                    </div>
                    <div class="computer-status-breakdown">
                        <span class="mini-stat open" title="Em Aberto">
                            ${comp.emAberto}
                        </span>
                        <span class="mini-stat progress" title="Em Andamento">
                            ${comp.emAndamento}
                        </span>
                        <span class="mini-stat resolved" title="Resolvidos">
                            ${comp.resolvidos}
                        </span>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Erro ao carregar computadores defeituosos:', error);
        document.getElementById('defectiveComputersList').innerHTML = 
            '<div class="error">Erro ao carregar dados</div>';
    }
}

// Fun√ß√£o para atualizar o indicador de √∫ltima atualiza√ß√£o
function updateLastRefreshIndicator() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR');
    
    let indicator = document.getElementById('lastRefreshIndicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'lastRefreshIndicator';
        indicator.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: opacity 0.3s ease;
        `;
        document.body.appendChild(indicator);
    }
    
    indicator.innerHTML = `√öltima atualiza√ß√£o: ${timeString}`;
    
    indicator.style.opacity = '1';
    setTimeout(() => {
        indicator.style.opacity = '0.7';
    }, 2000);
}

// Fun√ß√£o para recarregar todos os dados
function refreshAllData() {
    console.log('Atualizando dashboard...', new Date().toLocaleTimeString());
    loadStatusChart();
    loadMonthlyChart();
    loadSalaChart();
    loadDefectiveComputers();
    updateLastRefreshIndicator();
}

// Carregar dados iniciais e configurar auto-refresh
document.addEventListener('DOMContentLoaded', function() {
    refreshAllData();
    
    refreshInterval = setInterval(refreshAllData, 60000);
    
    console.log('‚úÖ Dashboard configurado com atualiza√ß√£o autom√°tica a cada 1 minuto');
});

// Limpar o intervalo quando a p√°gina for fechada/sa√≠da
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        console.log('üõë Auto-refresh parado');
    }
});
    </script>
</body>
</html>